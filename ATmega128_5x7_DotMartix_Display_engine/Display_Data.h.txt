#include <Arduino.h>
#include <avr/io.h>
#include <util/delay.h>
#include <Dot_matrix_Data.h>
/* ===== CLOCK PINS ===== */
#define CLK_U1 PC4   // Columns: DIS1,4,7 + shared DIS2,5,8
#define CLK_U3 PC3   // Columns: DIS3,6,9 + shared DIS2,5,8
#define CLK_U2 PC2   // Rows: DIS1,2,3
#define CLK_U4 PC1   // Rows: DIS4,5,6
#define CLK_U5 PC0   // Rows: DIS7,8,9
#define LED_PIN PC7 // On-board LED
/* ===== OUTPUT ENABLE ===== */
#define OE_COL PE2   // OE for U1 & U3 (columns only)

inline void pulse(uint8_t pin) {
 
  PORTC &= ~(1 << pin);
  _delay_us(1);
  PORTC |=  (1 << pin);
  _delay_us(1);
  
}

inline void columnsOff() {
  PORTE |= (1 << OE_COL);   // OE HIGH = columns OFF
}

inline void columnsOn() {
  PORTE &= ~(1 << OE_COL);  // OE LOW = columns ON
}

void intPort(){
    DDRA = 0xFF;                 // Data bus
    DDRC = 0b00011111;           // Clocks
    DDRE |= (1 << OE_COL);       // OE pin
}

// row scan patterns
uint8_t row[7] = {
    0x80, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02
};



// 5x7 font data for digits 1,4,7 using columns U1 
const uint8_t font5x7_data_digit1_4_7[10][7] = {
    {0xF1,0xEE,0xEC,0xEA,0xE6,0xEE,0xF1}, // 0
    {0xFB,0xF3,0xFB,0xFB,0xFB,0xFB,0xF1}, // 1
    {0xF1,0xEE,0xFE,0xFD,0xFB,0xF7,0xE0}, // 2
    {0xE0,0xFD,0xFB,0xFD,0xFE,0xEE,0xF1}, // 3
    {0xFD,0xF9,0xF5,0xED,0xE0,0xFD,0xFD}, // 4
    {0xE0,0xEF,0xE1,0xFE,0xFE,0xEE,0xF1}, // 5
    {0xF9,0xF7,0xEF,0xE1,0xEE,0xEE,0xF1}, // 6
    {0xE1,0xFE,0xFD,0xFB,0xF7,0xF7,0xF7}, // 7
    {0xF1,0xEE,0xEE,0xF1,0xEE,0xEE,0xF1}, // 8
    {0xF1,0xEE,0xEE,0xF0,0xFE,0xFD,0xF3}  // 9
};

// 5x7 font data for digits 3,6,9 using columns U3
const uint8_t font5x7_data_digit3_6_9[10][7] = {
    {0xC7,0xBB,0xB3,0xAB,0x9B,0xBB,0xC7}, // 0
    {0xEF,0xCF,0xEF,0xEF,0xEF,0xEF,0xC7}, // 1
    {0xC7,0xBB,0xFB,0xF7,0xEF,0xDF,0x83}, // 2
    {0x83,0xF7,0xEF,0xF7,0xFB,0xBB,0xC7}, // 3
    {0xF7,0xE7,0xD7,0xB7,0x83,0xF7,0xF7}, // 4
    {0x83,0xBF,0x87,0xFB,0xFB,0xFB,0xC7}, // 5
    {0xE7,0xDF,0xBF,0x87,0xBB,0xBB,0xC7}, // 6
    {0x83,0xFB,0xF7,0xEF,0xDF,0xDF,0xDF}, // 7
    {0xC7,0xBB,0xBB,0xC7,0xBB,0xBB,0xC7}, // 8
    {0xC7,0xBB,0xBB,0xC3,0xFB,0xF7,0xCF}  // 9
};

// 5x7 font data for digits 2,5,8 using columns U3 and U1
const uint8_t font5x7_data_digit2_5_8[10][2][7] = {
    { // 0
        {0x7E,0xFD,0xFD,0x7D,0xFC,0xFD,0x7E}, // U3
        {0xBF,0xDF,0x9F,0xDF,0xDF,0xDF,0xBF}  // U1
    },
    { // 1
        {0x7F,0x7E,0x7F,0x7F,0x7F,0x7F,0x7E},
        {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xBF}
    },
    { // 2
        {0x7E,0xFD,0xFF,0xFF,0x7F,0xFE,0x7C},
        {0xBF,0xDF,0xDF,0xBF,0xFF,0xFF,0x9F}
    },
    { // 3
        {0x7C,0xFF,0x7F,0xFF,0xFF,0xFD,0x7E},
        {0x9F,0xBF,0xFF,0xBF,0xDF,0xDF,0xBF}
    },
    { // 4
        {0xFF,0x7F,0xFE,0xFD,0x7C,0xFF,0xFF},
        {0xBF,0xBF,0xBF,0xBF,0x9F,0xBF,0xBF}
    },
    { // 5
        {0x7C,0xFD,0x7C,0xFF,0xFF,0xFD,0x7E},
        {0x9F,0xFF,0xBF,0xDF,0xDF,0xDF,0xBF}
    },
    { // 6
        {0x7F,0xFE,0xFD,0x7C,0xFD,0xFD,0x7E},
        {0xBF,0xFF,0xFF,0xBF,0xDF,0xDF,0xBF}
    },
    { // 7
        {0x7C,0xFF,0xFF,0x7F,0xFE,0xFE,0xFE},
        {0x9F,0xDF,0xBF,0xFF,0xFF,0xFF,0xFF}
    },
    { // 8
        {0x7E,0xFD,0xFD,0x7E,0xFD,0xFD,0x7E},
        {0xBF,0xDF,0xDF,0xBF,0xDF,0xDF,0xBF}
    },
    { // 9
        {0x7E,0xFD,0xFD,0x7E,0xFF,0xFF,0x7E},
        {0xBF,0xDF,0xDF,0x9F,0xDF,0xBF,0xFF}
    }
};


void display_digit(uint8_t digit,uint8_t value)
{
    columnsOff();

    // clear all latches
    PORTA = 0x00;
    pulse(CLK_U2);
    pulse(CLK_U4);
    pulse(CLK_U5);

    PORTA = 0xFF;
    pulse(CLK_U1);
    pulse(CLK_U3);

    columnsOn();

    for (uint8_t rowScan = 0; rowScan < 7; rowScan++)
    {
        columnsOff();

        // -------- ROW DATA --------
        PORTA = row[rowScan];

        if (digit >= 1 && digit <= 3)
            pulse(CLK_U2);
        else if (digit >= 4 && digit <= 6)
            pulse(CLK_U4);
        else
            pulse(CLK_U5);

        // -------- COLUMN DATA --------
        uint8_t u3 = 0xFF;
        uint8_t u1 = 0xFF;

        if (digit == 1 || digit == 4 || digit == 7)
        {
            u1 = font5x7_data_digit1_4_7[value][rowScan];
        }
        else if (digit == 3 || digit == 6 || digit == 9)
        {
            u3 = font5x7_data_digit3_6_9[value][rowScan];
        }
        else
        {
            u3 = font5x7_data_digit2_5_8[value][0][rowScan];
            u1 = font5x7_data_digit2_5_8[value][1][rowScan];
        }

        PORTA = u3;
        pulse(CLK_U3);

        PORTA = u1;
        pulse(CLK_U1);

        columnsOn();
        _delay_us(10);
    }
}
/////////////////////////////////////////
uint8_t get_digit(int number, uint8_t pos)
{
    while (pos--) number /= 10;
    return number % 10;
}

//////////////////////////////////////////////////
// Display a multi-digit number on the dot matrix display
///////////////////////////////////////////////////
void display_Number(int number)
{
    columnsOff();

    // clear all latches
    PORTA = 0x00;
    pulse(CLK_U2);
    pulse(CLK_U4);
    pulse(CLK_U5);

    PORTA = 0xFF;
    pulse(CLK_U1);
    pulse(CLK_U3);

    columnsOn();

    for (uint8_t digit = 1; digit <= 9; digit++)
    {
        uint8_t value = get_digit(number, digit - 1);

        for (uint8_t rowScan = 0; rowScan < 7; rowScan++)
        {
            columnsOff();

            // -------- ROW DATA --------
            PORTA = row[rowScan];

            if (digit >= 1 && digit <= 3)
                pulse(CLK_U2);
            else if (digit >= 4 && digit <= 6)
                pulse(CLK_U4);
            else
                pulse(CLK_U5);

            // -------- COLUMN DATA --------
            uint8_t u3 = 0xFF;
            uint8_t u1 = 0xFF;

            if (digit == 1 || digit == 4 || digit == 7)
            {
                u1 = font5x7_data_digit1_4_7[value][rowScan];
            }
            else if (digit == 3 || digit == 6 || digit == 9)
            {
                u3 = font5x7_data_digit3_6_9[value][rowScan];
            }
            else
            {
                u3 = font5x7_data_digit2_5_8[value][0][rowScan];
                u1 = font5x7_data_digit2_5_8[value][1][rowScan];
            }

            PORTA = u3;
            pulse(CLK_U3);

            PORTA = u1;
            pulse(CLK_U1);

            columnsOn();
            _delay_us(10);
        }
    }
}

////////////////////////////////////////////////////
// Display a multi-character number on the dot matrix display
////////////////////////////////////////////////////
void display_Char(uint8_t digit, const char* character)
{
    columnsOff();

    // clear all latches
    PORTA = 0x00;
    pulse(CLK_U2);
    pulse(CLK_U4);
    pulse(CLK_U5);

    PORTA = 0xFF;
    pulse(CLK_U1);
    pulse(CLK_U3);

    columnsOn();

   // for (uint8_t digit = 1; digit <= 9; digit++)
   // {
       // uint8_t value = character[digit - 1] - '0';

        for (uint8_t rowScan = 0; rowScan < 7; rowScan++)
        {
            columnsOff();

            // -------- ROW DATA --------
            PORTA = row[rowScan];

            if (digit >= 1 && digit <= 3)
                pulse(CLK_U2);
            else if (digit >= 4 && digit <= 6)
                pulse(CLK_U4);
            else
                pulse(CLK_U5);

            // -------- COLUMN DATA --------
            uint8_t u3 = 0xFF;
            uint8_t u1 = 0xFF;

            if (digit == 1 || digit == 4 || digit == 7)
            {
                //u1 = FontCharForDotMatrix_digit1_4_7[0][rowScan]; //font5x7_data_digit1_4_7[value][rowScan];
            }
            else if (digit == 3 || digit == 6 || digit == 9)
            {
                //u3 = //font5x7_data_digit3_6_9[value][rowScan];
            }
            else
            {
               // u3 = font5x7_data_digit2_5_8[value][0][rowScan];
                //u1 = font5x7_data_digit2_5_8[value][1][rowScan];
            }

            PORTA = 0xff;//u3;
            pulse(CLK_U3);

            PORTA = u1;
            pulse(CLK_U1);

            columnsOn();
            _delay_us(10);
        }
   // }
}